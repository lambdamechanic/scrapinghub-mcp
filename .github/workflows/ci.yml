name: ci

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
      - run: uv sync --frozen
      - run: uv run pytest
      - name: Build wheel
        run: uv build
      - name: Verify allowlist packaging
        run: |
          uv run -- python - <<'PY'
          from pathlib import Path
          import json
          import tarfile
          import zipfile

          wheels = sorted(Path("dist").glob("scrapinghub_mcp-*-py3-none-any.whl"))
          if not wheels:
              print("dist contents:", [p.name for p in Path("dist").glob("*")])
              raise SystemExit("No wheel found in dist/")
          wheel = wheels[-1]
          with zipfile.ZipFile(wheel) as zf:
              matches = [
                  name
                  for name in zf.namelist()
                  if name.endswith("scrapinghub_mcp/scrapinghub-mcp.allowlist.yaml")
              ]
          if not matches:
              raise SystemExit("Allowlist file missing from wheel.")
          allowlist_path = matches[0]
          print("Allowlist packaged:", allowlist_path)
          allowlist_content = zf.read(allowlist_path).decode("utf-8")
          schema_matches = [
              name
              for name in zf.namelist()
              if name.endswith("scrapinghub_mcp/allowlist-schema.json")
          ]
          if not schema_matches:
              raise SystemExit("Schema file missing from wheel.")
          wheel_schema = json.loads(zf.read(schema_matches[0]).decode("utf-8"))

          sdists = sorted(Path("dist").glob("scrapinghub_mcp-*.tar.gz"))
          if not sdists:
              print("dist contents:", [p.name for p in Path("dist").glob("*")])
              raise SystemExit("No sdist found in dist/")
          sdist = sdists[-1]
          with tarfile.open(sdist, "r:gz") as tf:
              sdist_matches = [
                  name
                  for name in tf.getnames()
                  if name.endswith("scrapinghub_mcp/scrapinghub-mcp.allowlist.yaml")
              ]
          if not sdist_matches:
              raise SystemExit("Allowlist file missing from sdist.")
          sdist_allowlist_path = sdist_matches[0]
          print("Allowlist packaged in sdist:", sdist_allowlist_path)
          sdist_content = tf.extractfile(sdist_allowlist_path).read().decode("utf-8")
          sdist_schema_matches = [
              name
              for name in tf.getnames()
              if name.endswith("scrapinghub_mcp/allowlist-schema.json")
          ]
          if not sdist_schema_matches:
              raise SystemExit("Schema file missing from sdist.")
          sdist_schema = json.loads(
              tf.extractfile(sdist_schema_matches[0]).read().decode("utf-8")
          )

          import jsonschema
          import yaml

          schema_path = Path("src/scrapinghub_mcp/allowlist-schema.json")
          if not schema_path.is_file():
              raise SystemExit(f"Missing schema file at {schema_path}")
          schema = json.loads(schema_path.read_text(encoding="utf-8"))
          if wheel_schema != schema:
              raise SystemExit("Wheel schema does not match source schema.")
          if sdist_schema != schema:
              raise SystemExit("Sdist schema does not match source schema.")

          for content in (allowlist_content, sdist_content):
              data = yaml.safe_load(content) or {}
              jsonschema.validate(data, schema)
          PY
